# Incremental Conversation Processing - Simple Session

This directory contains fixtures for testing incremental (realtime) conversation processing with a simple 2-turn Claude Code session.

## Test Scenario

**Session ID**: `3fb74381-1bf4-475e-8c6f-442d872b1bcf`  
**CodeMie Session ID**: `10358cef-a4f6-4266-9b5d-0d922e5342f6`  
**Working Directory**: `/Users/Nikita_Levyankov/repos/EPMCDME/codemie-ai/codemie-code`  
**Git Branch**: `hooks`

### Turn 1
- **User**: "show tools"
- **Assistant**: Lists available tools (Read, Write, Edit, Bash, Task, etc.)
- **Thinking**: 1 thought explaining the request
- **Tokens**: 20 input, 577 output, 60766 cache creation

### Turn 2
- **User**: "hi"
- **Assistant**: Greeting response
- **Thinking**: 1 thought
- **Tokens**: 20 input, 198 output, 61790 cache creation

## Files

### Input Files (Claude Session Data)

#### `turn-1.jsonl`
First 20 lines of the Claude session file after the first user turn.

**Original**: `~/.claude/projects/-Users-Nikita-Levyankov-repos-EPMCDME-codemie-ai-codemie-code/3fb74381-1bf4-475e-8c6f-442d872b1bcf.jsonl` (lines 1-20)

**Contains**:
- Summary messages
- File history snapshot
- User message: "show tools"
- Assistant thinking
- Assistant text response
- Stop hook (system message)

#### `turn-2.jsonl`
Complete 25-line Claude session file after the second user turn.

**Original**: Same as above (lines 1-25)

**Contains**:
- All messages from turn-1.jsonl
- User message: "hi"
- Assistant thinking
- Assistant text response
- Stop hook (system message)

### Expected Output Files (CodeMie Generated)

#### `expected-conversation.jsonl`
Expected conversation records generated by ConversationsProcessor after processing both turns.

**Format**: JSONL (one ConversationPayload per line)  
**Records**: 2

**Record 1** (Turn 1):
```json
{
  "timestamp": <unix_ms>,
  "isTurnContinuation": false,
  "historyIndices": [0, 0],
  "messageCount": 2,
  "payload": {
    "conversationId": "10358cef-a4f6-4266-9b5d-0d922e5342f6",
    "history": [
      {
        "role": "User",
        "message": "show tools",
        "history_index": 0,
        "date": "2026-01-15T17:24:23.966Z",
        ...
      },
      {
        "role": "Assistant",
        "message": "# Available Tools...",
        "history_index": 0,
        "input_tokens": 20,
        "output_tokens": 577,
        "thoughts": [...]
        ...
      }
    ]
  },
  "status": "pending"
}
```

**Record 2** (Turn 2):
- Similar structure
- User: "hi"
- Assistant greeting response
- history_index: 1 (incremented)

## Golden Dataset Expectations

**Total Records**: 2  
**Turn Continuations**: 0 (both are new turns)  
**Total Messages**: 4 (2 User + 2 Assistant)

**Record 1**:
- Status: `pending`
- Turn continuation: `false`
- Message count: 2
- User message: "show tools"
- Assistant tokens: 20 input, 577 output
- Thoughts: 1 (thinking thought)

**Record 2**:
- Status: `pending`
- Turn continuation: `false`
- Message count: 2
- User message: "hi"
- Assistant tokens: 20 input, 198 output
- Thoughts: 1 (thinking thought)

## Test Validation

The integration test validates:

1. **Incremental Processing**: 
   - Process turn-1.jsonl → 1 conversation record
   - Process turn-2.jsonl → 2 conversation records total

2. **Record Structure**:
   - Each record has status "pending"
   - Correct isTurnContinuation flag
   - User + Assistant message pairs
   - Thoughts included in Assistant messages

3. **Sync State**:
   - lastSyncedMessageUuid updated after each turn
   - lastSyncedHistoryIndex increments correctly

4. **Data Integrity**:
   - Generated records match expected-conversation.jsonl
   - Token counts accurate
   - Messages preserved exactly

## Usage in Tests

```typescript
import { join } from 'path';

const SIMPLE_FIXTURES_DIR = join(__dirname, 'fixtures', 'claude', 'incremental-simple');

// Process turn 1
await processSessionViaAdapter(
  join(SIMPLE_FIXTURES_DIR, 'turn-1.jsonl'),
  'test-session-id'
);

// Process turn 2
await processSessionViaAdapter(
  join(SIMPLE_FIXTURES_DIR, 'turn-2.jsonl'),
  'test-session-id'
);

// Validate against expected output
const expected = readFileSync(join(SIMPLE_FIXTURES_DIR, 'expected-conversation.jsonl'), 'utf-8');
```

## Notes

- Input files are real Claude Code session files
- Expected output generated by realtime simulation script
- No subagents in this session (simple conversation)
- System messages (stop hooks) filtered out correctly
- Both turns are new turns (not continuations)
