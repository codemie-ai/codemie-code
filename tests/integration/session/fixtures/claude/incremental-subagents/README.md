# Incremental Conversation Processing - Session with Subagents

This directory contains fixtures for testing incremental (realtime) conversation processing with a complex Claude Code session that includes subagent (Task tool) calls.

## Test Scenario

**Session ID**: `e9fb405b-169f-40eb-9396-7e75076f045d`  
**CodeMie Session ID**: `test-hook-e9fb405b` (test)  
**Working Directory**: `/Users/Nikita_Levyankov/repos/EPMCDME/codemie-ai/codemie-code`  
**Git Branch**: `hooks`  
**Subagent ID**: `a485154` (solution-architect)

### Turn 1 (Partial - lines 1-25)
- **User**: "@\"solution-architect (agent)\" analyze existing CLI command and create specification for adding missing CLI commands"
- **Assistant**: Empty (intermediate response, still processing)
- **Subagent**: solution-architect agent is invoked and starts processing
- **Thinking**: 16 thoughts (6 tools + 10 agent thoughts)
- **Tokens**: 26,302 input, 3,370 output

### Turn 2 (Complete - lines 1-50)
- **User**: Same as Turn 1
- **Assistant**: "## Summary\n\nI've analyzed the existing CLI command structure..." (final response)
- **Subagent**: solution-architect agent completes processing
- **Thinking**: 30 thoughts (14 tools + 16 agent thoughts)
- **Tokens**: 28,095 input, 12,575 output
- **Stop Hook**: Session ends with stop_hook_summary

## Files

### Input Files (Claude Session Data)

#### `e9fb405b-169f-40eb-9396-7e75076f045d-turn1.jsonl`
First 25 lines of the Claude session file (partial session).

**Original**: `~/.claude/projects/-Users-Nikita-Levyankov-repos-EPMCDME-codemie-ai-codemie-code/e9fb405b-169f-40eb-9396-7e75076f045d.jsonl` (lines 1-25)

**Contains**:
- Summary messages
- File history snapshot
- User message with @solution-architect agent call
- Multiple assistant messages (intermediate)
- Tool calls (Read, Grep, Task)
- Tool results with agentId references

**Subagent Files**:
- `e9fb405b-169f-40eb-9396-7e75076f045d-turn1/subagents/agent-a485154.jsonl` (338KB)

#### `e9fb405b-169f-40eb-9396-7e75076f045d-turn2.jsonl`
Complete 50-line Claude session file (full session).

**Original**: Same as above (lines 1-50)

**Contains**:
- All messages from turn1
- Additional assistant messages
- Final assistant text response
- Stop hook (system message)

**Subagent Files**:
- `e9fb405b-169f-40eb-9396-7e75076f045d-turn2/subagents/agent-a485154.jsonl` (338KB)

### Subagent Files

#### `agent-a485154.jsonl`
Solution-architect subagent session file containing detailed tool calls and analysis.

**Size**: ~338KB (large file with many tool calls)  
**Agent ID**: `a485154`  
**Session ID**: `e9fb405b-169f-40eb-9396-7e75076f045d` (matches main session)  
**Is Sidechain**: `true`

**Contains**:
- 20+ tool calls (Read, Grep, Write operations)
- Thinking content from solution-architect agent
- Token usage: 26,116 input, 2,086 output
- Model: claude-sonnet-4-5-20250929

### Expected Output Files (CodeMie Generated)

#### `expected-conversation.jsonl`
Expected conversation records generated by ConversationsProcessor after processing both turns with subagent integration.

**Format**: JSONL (one ConversationPayload per line)  
**Records**: 2

**Record 1** (Turn 1 - Partial):
```json
{
  "timestamp": <unix_ms>,
  "isTurnContinuation": false,
  "historyIndices": [0, 0],
  "messageCount": 2,
  "payload": {
    "conversationId": "test-session-id",
    "history": [
      {
        "role": "User",
        "message": "@\"solution-architect (agent)\" analyze...",
        "history_index": 0,
        ...
      },
      {
        "role": "Assistant",
        "message": "",  // Empty - intermediate
        "history_index": 0,
        "input_tokens": 26302,
        "output_tokens": 3370,
        "thoughts": [
          // 6 Tool thoughts
          // 10 Agent thoughts (including solution-architect)
        ]
        ...
      }
    ]
  },
  "status": "pending"
}
```

**Record 2** (Turn 2 - Complete, Turn Continuation):
```json
{
  "timestamp": <unix_ms>,
  "isTurnContinuation": true,  // Continuation!
  "historyIndices": [0],
  "messageCount": 1,  // Only Assistant
  "payload": {
    "conversationId": "test-session-id",
    "history": [
      {
        "role": "Assistant",
        "message": "## Summary\n\nI've analyzed...",
        "history_index": 0,
        "input_tokens": 28095,
        "output_tokens": 12575,
        "thoughts": [
          // 14 Tool thoughts
          // 16 Agent thoughts with full subagent data
          {
            "id": "agent-a485154",
            "metadata": {
              "agent_id": "a485154",
              "subagent_type": "solution-architect",
              "token_usage": {
                "input": 26116,
                "output": 2086,
                ...
              }
            },
            "author_type": "Agent",
            "author_name": "solution-architect",
            "message": "Analyze the existing CLI command structure...",
            "children": [
              // 20 tool calls from subagent
            ]
          }
        ]
        ...
      }
    ]
  },
  "status": "pending"
}
```

## Golden Dataset Expectations

**Total Records**: 2  
**Turn Continuations**: 1 (Record 2)  
**Total Messages**: 3 (1 User + 2 Assistant)  
**Subagents**: 1 (solution-architect, agent-a485154)

**Record 1** (Partial):
- Status: `pending`
- Turn continuation: `false`
- Message count: 2 (User + Assistant)
- Assistant message: Empty (intermediate)
- Assistant tokens: 26,302 input, 3,370 output
- Thoughts: 16 (6 tools + 10 agents)
- Agent thoughts: 10 (includes partial subagent data)

**Record 2** (Complete, Turn Continuation):
- Status: `pending`
- Turn continuation: `true` ✓
- Message count: 1 (Assistant only) ✓
- Assistant message: Complete response text
- Assistant tokens: 28,095 input, 12,575 output
- Thoughts: 30 (14 tools + 16 agents)
- Agent thoughts: 16 (includes full subagent data)

**Subagent Integration**:
- Agent ID: `a485154`
- Subagent type: `solution-architect`
- Token usage: 26,116 input, 2,086 output
- Tool calls: 20 (from subagent's children array)
- Message: Full subagent analysis text

## Test Validation

The integration test validates:

1. **Incremental Processing with Subagents**:
   - Process turn-1 → 1 record with partial subagent data
   - Process turn-2 → 2 records with complete subagent integration

2. **Turn Continuation Detection**:
   - Record 1: isTurnContinuation = false (new turn)
   - Record 2: isTurnContinuation = true (continuation)
   - Record 2 has only Assistant message (no User)

3. **Subagent Discovery**:
   - Adapter finds `agent-a485154.jsonl` in subagents directory
   - Parses subagent file automatically
   - Aggregates tokens from main + subagent

4. **Agent Thought Structure**:
   - Agent thoughts have `author_type: "Agent"`
   - Metadata includes `agent_id`, `subagent_type`, `token_usage`
   - Children array contains subagent's tool calls
   - Message contains subagent's full output

5. **Token Aggregation**:
   - Main session tokens + subagent tokens
   - Tokens preserved in agent thought metadata
   - Total tokens match expected values

6. **System Message Filtering**:
   - Stop hooks not included in conversation history
   - Turn boundaries detected at system messages

## Directory Structure

```
incremental-subagents/
├── README.md
├── e9fb405b-169f-40eb-9396-7e75076f045d-turn1.jsonl  # Turn 1 (25 lines)
├── e9fb405b-169f-40eb-9396-7e75076f045d-turn2.jsonl  # Turn 2 (50 lines)
├── e9fb405b-169f-40eb-9396-7e75076f045d-turn1/
│   └── subagents/
│       └── agent-a485154.jsonl  # Subagent file (338KB)
├── e9fb405b-169f-40eb-9396-7e75076f045d-turn2/
│   └── subagents/
│       └── agent-a485154.jsonl  # Same subagent file
└── expected-conversation.jsonl  # Expected output (2 records)
```

## Usage in Tests

```typescript
import { join } from 'path';

const SUBAGENTS_FIXTURES_DIR = join(__dirname, 'fixtures', 'claude', 'incremental-subagents');

// Process turn 1 (with partial subagent)
await processSessionViaAdapter(
  join(SUBAGENTS_FIXTURES_DIR, 'e9fb405b-169f-40eb-9396-7e75076f045d-turn1.jsonl'),
  'test-session-id'
);

// Verify subagent directory structure
const subagentsDir = join(SUBAGENTS_FIXTURES_DIR, 'e9fb405b-169f-40eb-9396-7e75076f045d-turn1', 'subagents');
expect(existsSync(subagentsDir)).toBe(true);

// Process turn 2 (complete with full subagent)
await processSessionViaAdapter(
  join(SUBAGENTS_FIXTURES_DIR, 'e9fb405b-169f-40eb-9396-7e75076f045d-turn2.jsonl'),
  'test-session-id'
);

// Validate agent thoughts
const records = readConversationFile('test-session-id');
const agentThoughts = records[1].payload.history[0].thoughts.filter(
  t => t.author_type === 'Agent'
);
expect(agentThoughts.length).toBe(16);
```

## Notes

- Input files are real Claude Code session files with Task tool usage
- Subagent files are automatically discovered by matching sessionId
- Turn 2 creates a turn continuation record (not a new turn)
- Agent thoughts preserve full subagent metadata and tool calls
- Token aggregation includes both main session and subagent tokens
- This demonstrates the most complex scenario: incremental + subagents + turn continuations
